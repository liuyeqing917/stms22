<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../js/layout.js" ></script>
		<link rel="stylesheet" type="text/css" href="../css/bootstrap-datetimepicker.min.css"/>
		<script type="text/javascript" src="../js/bootstrap-datetimepicker.min.js" ></script>
		<meta charset="UTF-8">
		<title>高州市人民医院 - 住院医师轮转系统 - 修改个人信息</title>
		<style type="text/css">
			
			.row{
				margin-top:17px;
			}
			
			.notnull{
				color:red; text-align:left; height:34px; line-height:34px;
			}
			.text{text-align:right; height:34px; line-height:34px;}
			.radioDiv{height:34px; line-height:34px;}

			.btnRow button{
				display:block; background-color:#DC5C59; border-radius:5px;
				color:white; font-weight:bold; width:70px; height:30px;
				margin:auto;
			}
			
			.goback{

			}
		</style>
		<script>
			
		</script>
	</head>
	<body>
		<div class="childTitle">
			修改个人信息
		</div>
		<form class="registerForm">
		<input type="hidden" name="hospital_id" value="1" />
		<div class="row clearfix">

			<div class="col-xs-2 text">
				姓名:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control notNullInput name" name="name" />
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

			<div class="col-xs-2 text">
				性别:
			</div>
			<div class="col-xs-1 radioDiv">
				<input type="radio" name="sex" value="1" checked="checked" id="man"/>
				<label for="man">男</label>
			</div>
			<div class="col-xs-1 radioDiv">
				<input type="radio" name="sex" value="0" id="woman"/>
				<label for="woman">女</label>
			</div>
		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				学员类型:
			</div>
			<div class="col-xs-2 radioDiv" style="padding-right:0;">
				<input type="radio" name="stu_type" value="1" checked="checked" id="zaixiao"/>
				<label for="zaixiao">在校生</label>
			</div>
			<div class="col-xs-2 radioDiv">
				<input type="radio" name="stu_type" value="2" id="fivethree"/>
				<label for="fivethree">5+3</label>
			</div>
			<div class="col-xs-2 radioDiv">
				<input type="radio" name="stu_type" value="3" id="hangye"/>
				<label for="hangye">行业</label>
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

		</div>
		
		<div class="row clearfix">
			<div class="col-xs-2 text">
				证件类型:
			</div>
			<div class="col-xs-3">
				<select value="" class="form-control notNullInput" name="certificate_type">
					<option value="1">身份证</option>
					<option value="2">居住证</option>
					<option value="3">户口本</option>
					<option value="4">军人证</option>
					<option value="5">护照</option>
				</select>
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

			<div class="col-xs-2 text">
				证件号码:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control notNullInput certificate_number" name="certificate_number" />
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>
		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				民族:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control notNullInput national" name="national" />
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

			<div class="col-xs-2 text">
				生日:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control notNullInput ctime" name="birthday" />
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>
		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				手机:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control notNullInput mobile" name="phone_number" />
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

			<div class="col-xs-2 text">
				固定电话:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control" name="fixed_number" />
			</div>
			<div class="col-xs-1">
				
			</div>
		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				电子邮箱:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control email" name="email" />
			</div>
			<div class="col-xs-1">
				
			</div>

			<div class="col-xs-2 text">
				外语能力:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control" name="foreign_blity" />
			</div>
			<div class="col-xs-1">
				
			</div>
		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				方向科室:
			</div>
			<div class="col-xs-3">
				<select class="form-control fatherdepart">
					
				</select>
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

			<div class="col-xs-2 text">
				科室选择:
			</div>
			<div class="col-xs-3">
				<select value="" class="form-control childdepart" name="department_id">
					
				</select>
			</div>
			<div class="col-xs-1 notnull">
				*
			</div>

		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				通讯地址:
			</div>
			<div class="col-xs-9">
				<input type="text" class="form-control" name="communication_adress" />
			</div>

		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				紧急联系人:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control" name="emergency_contact" />
			</div>
			<div class="col-xs-1">
				
			</div>

			<div class="col-xs-2 text">
				联系人手机:
			</div>
			<div class="col-xs-3">
				<input type="text" class="form-control" name="ec_number" />
			</div>
			<div class="col-xs-1">
				
			</div>
		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				紧急联系人地址:
			</div>
			<div class="col-xs-9">
				<input type="text" class="form-control" name="ec_adress" />
			</div>

		</div>

		<div class="row clearfix">
			<div class="col-xs-2 text">
				自我介绍
			</div>

		</div>

		<div class="row clearfix">
			<div class="col-xs-2">
				
			</div>
			<div class="col-xs-9">
				<textarea class="form-control" rows="5" name="self_introduce"></textarea>
			</div>
		</div>
		<input type="hidden" name="id" value="">
		<input type="hidden" name="token" value="">
		</form>

		<div class="row clearfix btnRow" style="margin-bottom:30px;">
			<div class="col-xs-5"></div>
			<div class="col-xs-2"><button type="button" class="save">修改</button></div>
		</div>
	</body>
	<script type="text/javascript">
		function setDatePicker(){//时间日期插件设置

			$(".ctime").datetimepicker({
				minView:'2',
				format: "yyyy-mm-dd",
				autoclose: true,
				pickerPosition: "bottom-left"
			});
		}

		$(document).ready(function() {
			setDatePicker();//设置时间插件
			//getFatherdepart();获取父科室
			//getChilddepart();//获取子科室
			searchPInfo();//获取个人信息
			getIdToken();//获取id和token填到表单中
		});

		function getIdToken(){//获取id和token
			$("input[name='id']").val( getCookie("id") );
			$("input[name='token']").val( getCookie("token") );
		}

		function searchPInfo() {//获取个人信息
			var token = getCookie("token");
			var userNum = getCookie("usernumber");
			Api.searchPInfo({
				json:{
						usernumber:userNum,
						token:token
					},
				fn:function (arr) {
					
					console.log(arr);
					$("input[name='name']").val(arr[0].name);
					$("input[name='certificate_number']").val(arr[0].certificate_number);
					$("input[name='national']").val(arr[0].national);
					$("input[name='birthday']").val(timetodate(arr[0].birthday,1));
					$("input[name='phone_number']").val(arr[0].phone_number);
					$("input[name='fixed_number']").val(arr[0].fixed_number);
					$("input[name='email']").val(arr[0].email);
					$("input[name='foreign_blity']").val(arr[0].foreign_blity);
					$("input[name='communication_adress']").val(arr[0].communication_adress);
					$("input[name='emergency_contact']").val(arr[0].emergency_contact);
					$("input[name='ec_number']").val(arr[0].ec_number);
					$("input[name='ec_adress']").val(arr[0].ec_adress);
					$("textarea[name='self_introduce']").val(arr[0].self_introduce);

					var stu_type_temp = arr[0].stu_type; stu_type_temp--;
					$("input[name='stu_type']").eq(stu_type_temp).attr('checked', 'checked');

					if( arr[0].sex == 1 ){
						$("input[name='sex']").eq(0).attr('checked', 'checked');
					}else{
						$("input[name='sex']").eq(1).attr('checked', 'checked');
					}

					var certificate_type_temp = arr[0].certificate_type; certificate_type_temp--;
					$("select[name='certificate_type']").children().eq(certificate_type_temp).attr('selected', 'selected');

					var fatherdepartid = arr[0].fatherdepartid;
					//$(".fatherdepart").children('[value='+fatherdepartid+']').attr('selected', 'selected');

					var department_id = arr[0].department_id;
					//$(".childdepart").children('[value='+department_id+']').attr('selected', 'selected');

					getFatherdepart(fatherdepartid,department_id);//对应用户的父科室和子科室
				}
			});
		}

		function getFatherdepart(fatherdepartid,department_id){//获取父科室

			Api.fatherdepart({
				istoken:1,
				fn:function (arr) {
					console.log(arr);
					$(".fatherdepart").empty();
					for(var i = 0; i < arr.length; i++){
						$(".fatherdepart").append('<option value="'+arr[i]['id']+'">'+arr[i]['name']+'</option>');
					}
					$(".fatherdepart").children('[value='+fatherdepartid+']').attr('selected', 'selected');//选择用户对应的父科室
					childPartFirst(fatherdepartid,department_id);//父科室加载完后加载子科室
				}
			});
		}

		function getChilddepart(){//获取子科室

			$(".fatherdepart").change(function() {
				var fatherId = $(".fatherdepart").val();
				$(".childdepart").empty(); $('.childdepart').val('');
				Api.childdepart({
					istoken:1,
					json:{
						pid:fatherId
					},
					fn:function (arr) {
						for(var i = 0; i < arr.length; i++){
							$(".childdepart").append('<option value="'+arr[i]['id']+'">'+arr[i]['name']+'</option>');
						}
					}
				});
			});

		}

		function childPartFirst(fatherdepartid,department_id){//父科室加载完后加载子科室
			//var fatherId = $(".fatherdepart").children().eq(0).val();
			$(".childdepart").empty(); $('.childdepart').val('');
			Api.childdepart({
				istoken:1,
				json:{
					pid:fatherdepartid
				},
				fn:function (arr) {
					for(var i = 0; i < arr.length; i++){
						$(".childdepart").append('<option value="'+arr[i]['id']+'">'+arr[i]['name']+'</option>');
					}
					$(".childdepart").children('[value='+department_id+']').attr('selected', 'selected');//选择用户对应的子科室
					getChilddepart();//获取子科室
				}
			});
		}


		$(".save").click(function() {

			if(!/^[\u4e00-\u9fa5|a-z|A-Z]{1,10}$/.test($.trim($('.name').val()))){// 验证汉字或者字母
				$('.name').focus();
				uselayer(3,'姓名只能是汉字或者字母');
				return false;
			}				

			if(!/^\d{15,18}$/.test($.trim($('.certificate_number').val()))){// 数字
				$('.certificate_number').focus();
				uselayer(3,'请输入正确的证件号！');
				return false;
			}				
			
			if(!/^[\u4e00-\u9fa5]{1,10}$/.test($.trim($('.national').val()))){// 汉字
				$('.national').focus();
				uselayer(3,'名族必须为汉字！');
				return false;
			}				
			
			if(!/^\d{4}-\d{2}-\d{2}$/.test($.trim($('.ctime').val()))){
				$('.ctime').focus();
				uselayer(3,'日期格式错误');
				return false;
			}		
			
			if(!/^1[3-578]\d{9}$/.test($.trim($('.mobile').val()))){
				$('.mobile').focus();
				uselayer(3,'请输入正确的手机号');
				return false;
			}
			
			if(!/^\w{3,18}@[a-z0-9\-]+(\.[a-z]{2,6}){1,2}$/i.test($.trim($('.email').val()))){
				$('.email').focus();
				uselayer(3,'请输入正确的邮箱地址');
				return false;
			}		
			
			if(!$.trim($('.childdepart').val())){
				$('.childdepart').focus();
				uselayer(3,'科室必选，不能为空！');
				return false;
			}		
			
			uselayer(2,'您确定要提交修改吗?',function () {
				$('.ctime').val(new Date($('.ctime').val()).getTime()/1000);
				//提交个人信息修改
				Api.editPInfo({
					istoken:1,
					json:$(".registerForm").serialize(),
					fn:function (arr) {
						console.log(arr);
						$('.ctime').val(timetodate($('.ctime').val(),1));
						if(arr['status'] == 1 ){
							uselayer(3,'修改成功！',function () {
								window.location.reload();
							});
						}else {
							
							uselayer(3,arr['msg']);
						}
					}
				});				
			});


		});

		function checkNull(){//判断表单是否空
			var isNull = 0;
			$(".notNullInput").each(function(){
			    if( $(this).val().trim() == "" ){
			    	isNull = 1;
			    	
			    }
			});
			if( isNull == 1 ){
				layer.alert('你有必填的表单为空！', {
					btn: ['确定']
				});
			}
			return isNull;
		}

	</script>
</html>
